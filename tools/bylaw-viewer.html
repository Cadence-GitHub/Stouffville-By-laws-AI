<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whitchurch-Stouffville Bylaw Viewer</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: #fff;
            --hover-color: #3498db;
            --border-color: #ddd;
            --sidebar-width: 300px;
            --header-height: 60px;
            --section-padding: 15px;
            --section-spacing: 15px;
            --section-border-radius: 8px;
            --transition-speed: 0.3s;
        }

        [data-theme="dark"] {
            --primary-color: #2980b9;
            --secondary-color: #3498db;
            --text-color: #f5f5f5;
            --bg-color: #1a1a1a;
            --card-bg: #2c2c2c;
            --hover-color: #3498db;
            --border-color: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            display: flex;
            align-items: center;
        }

        .header-title h1 {
            font-size: 1.5rem;
            margin-left: 10px;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
        }

        .toggle-label {
            margin-right: 10px;
            font-size: 0.9rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2196F3;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .container {
            display: flex;
            margin-top: var(--header-height);
            height: calc(100vh - var(--header-height));
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--card-bg);
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
        }

        .search-container {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .bylaw-list {
            list-style: none;
        }

        .bylaw-item {
            padding: 10px 8px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .bylaw-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .bylaw-item.active {
            background-color: rgba(52, 152, 219, 0.2);
            font-weight: bold;
        }

        .bylaw-number {
            font-weight: bold;
            display: block;
            margin-bottom: 2px;
        }

        .bylaw-type {
            font-size: 0.85rem;
            color: #777;
        }

        [data-theme="dark"] .bylaw-type {
            color: #aaa;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }
        
        .dropzone {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: 100%;
            height: calc(100vh - var(--header-height));
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        
        .dropzone-content {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            width: 400px;
            max-width: 90%;
        }
        
        .file-icon {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        
        .file-input-label:hover {
            background-color: var(--hover-color);
        }
        
        #file-input {
            display: none;
        }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .file-info {
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        
        .file-count {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .file-action {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--hover-color);
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-outline:hover {
            background-color: var(--bg-color);
        }

        .bylaw-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .bylaw-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .bylaw-subtitle {
            font-size: 1.2rem;
            color: var(--secondary-color);
            font-weight: normal;
        }

        .bylaw-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .bylaw-section {
            background-color: var(--card-bg);
            padding: var(--section-padding);
            margin-bottom: var(--section-spacing);
            border-radius: var(--section-border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
        }

        .section-content {
            font-size: 0.95rem;
        }

        .section-content p {
            margin-bottom: 10px;
        }

        .section-content ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .bylaw-text {
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: var(--bg-color);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: var(--text-color);
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        [data-theme="dark"] .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
        }

        .no-bylaws {
            text-align: center;
            padding: 20px;
            color: var(--text-color);
        }

        /* Responsive styles */
        @media (max-width: 992px) {
            .bylaw-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 250px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .header-title h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-title">
            <h1>Whitchurch-Stouffville Bylaw Viewer</h1>
        </div>
        <div class="theme-toggle">
            <span class="toggle-label">Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="theme-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </header>
    
    <div id="dropzone" class="dropzone">
        <div class="dropzone-content">
            <div class="file-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
            </div>
            <h3>Drop JSON files here</h3>
            <p>or</p>
            <label for="file-input" class="file-input-label">Select Files</label>
            <input type="file" id="file-input" accept=".json" multiple>
        </div>
    </div>

    <div class="container">
        <aside class="sidebar">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search bylaws...">
            </div>
            <ul class="bylaw-list" id="bylaw-list">
                <!-- Bylaw items will be dynamically added here -->
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Loading bylaws...</span>
                </div>
            </ul>
        </aside>

        <main class="content" id="content">
            <!-- Bylaw content will be dynamically loaded here -->
            <div class="no-bylaws">
                <h2>Select a bylaw from the sidebar to view its details</h2>
            </div>
        </main>
    </div>

    <script>
        // Sample data structure for demo - will be replaced by actual JSON data
        let bylawData = [];
        let uploadedFiles = [];

        // DOM Elements
        const themeToggle = document.getElementById('theme-toggle');
        const searchInput = document.getElementById('search-input');
        const bylawList = document.getElementById('bylaw-list');
        const contentArea = document.getElementById('content');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');

        // Theme toggle functionality
        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        });

        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            themeToggle.checked = true;
        }

        // Mock function to load data - in a real application, this would fetch data from a server
        function loadBylawData() {
            // Parse the JSON data from documents
            const documents = []; // This would be filled with actual document data
            
            // Processing document data into bylawData
            for (const doc of documents) {
                const docContent = JSON.parse(doc.document_content);
                bylawData.push(docContent);
            }
            
            // For demonstration purposes, let's simulate loading some bylaw data
            bylawData = [
                {
                    "bylawNumber": "2024-001-PR",
                    "bylawType": "Parking Regulation",
                    "bylawYear": "2024",
                    "condtionsAndClauses": "That this By-law shall be deemed to have come into effect immediately.",
                    "entityAndDesignation": "Iain Lovatt, Mayor%%%Becky Jamieson, Clerk",
                    "extractedText": [
                        "THE CORPORATION OF THE TOWN OF WHITCHURCH-STOUFFVILLE\nBY-LAW NUMBER 2024-001-PR\n\nBEING A BY-LAW to amend By-law 2008-114-PR, to\ngovern and control the parking of vehicles in the Town of\nWhitchurch-Stouffville\n\nWHEREAS Section 11 (3) of the Municipal Act, 2001, S.O., 2001, c.25, as amended,\nauthorizes a municipality to pass By-laws prohibiting or regulating parking and traffic\non highways and on properties other than highways; and\n\nWHEREAS Council passed By-law 2008-114-PR to govern and control the parking\nof vehicles in the Town of Whitchurch-Stouffville.\n\nNOW THEREFORE THE COUNCIL OF THE CORPORATION OF THE TOWN OF\nWHITCHURCH-STOUFFVILLE ENACTS AS FOLLOWS:\n\n1. That Schedule III (Three (3) Hour Parking Exemptions) to By-law 2008-114-\nPR be amended to exempt the three-hour parking rule and that Section 17,\nOn Street Parking - Winter Months shall not apply in the following locations.\n\n\nHighway Side Location Permitted Days\nor Times\nDougherty East Parallel to the Ninth Line Daily\nCrescent 4 p.m. to 9 a.m.\nDougherty East Between #80 and #126 Anytime\nCrescent Dougherty Crescent\nDougherty North Between Weldon Road and #73 Anytime\nCrescent Dougherty Crescent\nDougherty South Between Weldon Road and Anytime\nCrescent #127 Dougherty Crescent\nFirbank North Between #3 and #23 Firbank Anytime\nLane Lane\nFirbank West Between #26 and #100 Firbank Anytime\nLane Lane\nHoppington West & Between Mantle Avenue and Anytime\nAvenue South Firbank Lane\nJamesway East & Between Weldon Road and Anytime\nCrescent North Dougherty Crescent\n\n2. That this By-law shall be deemed to have come into effect immediately.\n\nREAD a first and second time this 2nd day of January, 2024.\n\nREAD a third time and passed this 2nd day of January, 2024.\n\n\nMAR\n\nIain Lovatt, Mayor\n\n\nBecky Jamica\nBecky Jamieson, Clerk\n----------------------------------------------------------------------------------------------------"
                    ],
                    "hasEmbeddedImages": true,
                    "keyDatesAndInfo": [
                        "02-JAN-2024: Read a first and second time",
                        "02-JAN-2024: Read a third time and passed"
                    ],
                    "laymanExplanation": "This bylaw amends a previous bylaw (2008-114-PR) to change the parking rules in Whitchurch-Stouffville. Specifically, it modifies Schedule III to exempt certain locations from the three-hour parking rule and states that Section 17 regarding on-street parking during winter months will not apply to the locations listed in the schedule. The bylaw takes effect immediately.",
                    "legislation": "Municipal Act, 2001, S.O., 2001, c.25, Section 11(3)",
                    "table": [
                        "Highway|Side|Location|Permitted Days or Times",
                        "Dougherty Crescent|East|Parallel to the Ninth Line|Daily 4 p.m. to 9 a.m.",
                        "Dougherty Crescent|East|Between #80 and #126 Dougherty Crescent|Anytime",
                        "Dougherty Crescent|North|Between Weldon Road and #73 Dougherty Crescent|Anytime",
                        "Dougherty Crescent|South|Between Weldon Road and #127 Dougherty Crescent|Anytime",
                        "Firbank Lane|North|Between #3 and #23 Firbank Lane|Anytime",
                        "Firbank Lane|West|Between #26 and #100 Firbank Lane|Anytime",
                        "Hoppington Avenue|West & South|Between Mantle Avenue and Firbank Lane|Anytime",
                        "Jamesway Crescent|East & North|Between Weldon Road and Dougherty Crescent|Anytime"
                    ]
                },
                {
                    "bylawNumber": "2024-002-MS",
                    "bylawType": "Miscellaneous",
                    "bylawYear": "2024",
                    "condtionsAndClauses": "That every action of the Council of The Corporation of the Town of Whitchurch-Stouffville taken at its special meeting held on the 2nd day of January 2024, upon which a vote was taken and passed whether a resolution, recommendations, adoption by reference, or other means, is hereby enacted as a by-law of the Town to take effect upon the passing hereof except where the approval of the Ontario Land Tribunal is required, in which case the effective date shall be the day after the approval of the Ontario Land Tribunal is obtained or such other day as the Ontario Land Tribunal may order; and",
                    "entityAndDesignation": "Iain Lovatt, Mayor|||Becky Jamieson, Clerk",
                    "laymanExplanation": "This bylaw confirms the actions taken by the Town of Whitchurch-Stouffville Council at a special meeting held on January 2, 2024. It states that all decisions made during that meeting become official bylaws, except for those requiring approval from the Ontario Land Tribunal, which will take effect after that approval is obtained. The bylaw also authorizes the Mayor and Clerk to execute necessary documents and affix the corporate seal to implement these actions."
                }
            ];

            // Render the bylaw list
            renderBylawList();
        }

        // Function to render the list of bylaws in the sidebar
        function renderBylawList(searchTerm = '') {
            // Clear the current list
            bylawList.innerHTML = '';

            // Filter bylaws based on search term if provided
            const filteredBylaws = searchTerm
                ? bylawData.filter(bylaw => 
                    bylaw.bylawNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    bylaw.bylawType.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (bylaw.laymanExplanation && bylaw.laymanExplanation.toLowerCase().includes(searchTerm.toLowerCase()))
                )
                : bylawData;

            // Check if there are any bylaws to display
            if (filteredBylaws.length === 0) {
                bylawList.innerHTML = '<div class="no-bylaws">No bylaws found</div>';
                return;
            }

            // Sort bylaws by number
            filteredBylaws.sort((a, b) => {
                return a.bylawNumber.localeCompare(b.bylawNumber);
            });

            // Create list items for each bylaw
            filteredBylaws.forEach(bylaw => {
                const listItem = document.createElement('li');
                listItem.className = 'bylaw-item';
                listItem.dataset.bylawId = bylaw.bylawNumber;
                listItem.innerHTML = `
                    <span class="bylaw-number">${bylaw.bylawNumber}</span>
                    <span class="bylaw-type">${bylaw.bylawType}</span>
                `;
                listItem.addEventListener('click', () => {
                    // Remove active class from all items
                    document.querySelectorAll('.bylaw-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    // Add active class to clicked item
                    listItem.classList.add('active');
                    // Display the selected bylaw
                    displayBylaw(bylaw);
                });
                bylawList.appendChild(listItem);
            });
        }

        // Function to format text with various separators
        function formatText(text) {
            if (!text) return '';
            
            // Handle newlines
            let formattedText = text.replace(/\n/g, '<br>');
            
            // Handle multiple dashes as separators (4 or more)
            formattedText = formattedText.replace(/----+/g, '<hr>');
            
            // Handle percentage signs as separators
            formattedText = formattedText.replace(/%%%/g, ', ');
            
            // Handle triple pipe as separators
            formattedText = formattedText.replace(/\|\|\|/g, ', ');
            
            // Handle pipe separators in non-table content for single pipes
            // We need to be careful not to affect table data
            if (!formattedText.includes('<table>')) {
                formattedText = formattedText.replace(/\|/g, ' | ');
            }
            
            return formattedText;
        }

        // Function to format tabular data
        function formatTable(tableData) {
            if (!tableData || !tableData.length) return '';
            
            let html = '<table>';
            
            // Process header row
            const headerRow = tableData[0];
            const headers = headerRow.split('|');
            
            html += '<tr>';
            headers.forEach(header => {
                html += `<th>${header.trim()}</th>`;
            });
            html += '</tr>';
            
            // Process data rows
            for (let i = 1; i < tableData.length; i++) {
                const rowData = tableData[i].split('|');
                html += '<tr>';
                rowData.forEach(cell => {
                    html += `<td>${cell.trim()}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</table>';
            return html;
        }

        // Function to format lists
        function formatList(listItems) {
            if (!listItems || !listItems.length) return '';
            
            let html = '<ul>';
            listItems.forEach(item => {
                html += `<li>${formatText(item)}</li>`;
            });
            html += '</ul>';
            
            return html;
        }

        // Function to display a bylaw
        function displayBylaw(bylaw) {
            // Clear the content area
            contentArea.innerHTML = '';
            
            // Create the bylaw header
            const header = document.createElement('div');
            header.className = 'bylaw-header';
            header.innerHTML = `
                <h2 class="bylaw-title">${bylaw.bylawNumber}</h2>
                <h3 class="bylaw-subtitle">${bylaw.bylawType} (${bylaw.bylawYear})</h3>
            `;
            contentArea.appendChild(header);
            
            // Create the bylaw container
            const container = document.createElement('div');
            container.className = 'bylaw-container';
            
            // Determine if a field should be displayed - not empty, not "None", and not false
            function shouldDisplay(field) {
                if (field === undefined || field === null) return false;
                if (field === false) return false;
                if (typeof field === 'string' && (field.trim() === '' || field.toLowerCase() === 'none')) return false;
                if (Array.isArray(field) && field.length === 0) return false;
                if (Array.isArray(field) && field.length === 1 && field[0].toLowerCase() === 'none') return false;
                return true;
            }
            
            // Helper function to create a section
            function createSection(title, content, fullWidth = false, isHTML = false) {
                if (!shouldDisplay(content)) return null;
                
                const section = document.createElement('div');
                section.className = `bylaw-section ${fullWidth ? 'full-width' : ''}`;
                
                let formattedContent;
                if (isHTML) {
                    formattedContent = content;
                } else if (Array.isArray(content)) {
                    formattedContent = formatList(content);
                } else {
                    formattedContent = `<p>${formatText(content)}</p>`;
                }
                
                section.innerHTML = `
                    <h4 class="section-title">${title}</h4>
                    <div class="section-content">
                        ${formattedContent}
                    </div>
                `;
                
                return section;
            }
            
            // Layman's explanation section
            const explanationSection = createSection('Summary', bylaw.laymanExplanation, true);
            if (explanationSection) container.appendChild(explanationSection);
            
            // Key dates and info section
            const datesSection = createSection('Key Dates', bylaw.keyDatesAndInfo);
            if (datesSection) container.appendChild(datesSection);
            
            // Conditions and clauses section
            const conditionsSection = createSection('Conditions and Clauses', bylaw.condtionsAndClauses);
            if (conditionsSection) container.appendChild(conditionsSection);
            
            // Legal Topics section
            const legalTopicsSection = createSection('Legal Topics', bylaw.legalTopics);
            if (legalTopicsSection) container.appendChild(legalTopicsSection);
            
            // Legislation section
            const legislationSection = createSection('Legislation', bylaw.legislation);
            if (legislationSection) container.appendChild(legislationSection);
            
            // Why Legislation section
            const whyLegislationSection = createSection('Why Legislation', bylaw.whyLegislation);
            if (whyLegislationSection) container.appendChild(whyLegislationSection);
            
            // Other Bylaws section
            const otherBylawsSection = createSection('Other Bylaws', bylaw.otherBylaws);
            if (otherBylawsSection) container.appendChild(otherBylawsSection);
            
            // Why Other Bylaws section
            const whyOtherBylawsSection = createSection('Why Other Bylaws', bylaw.whyOtherBylaws);
            if (whyOtherBylawsSection) container.appendChild(whyOtherBylawsSection);
            
            // Entity and designation section
            const entitySection = createSection('Entity and Designation', bylaw.entityAndDesignation);
            if (entitySection) container.appendChild(entitySection);
            
            // Other Entities Mentioned section
            const otherEntitiesSection = createSection('Other Entities Mentioned', bylaw.otherEntitiesMentioned);
            if (otherEntitiesSection) container.appendChild(otherEntitiesSection);
            
            // Location Addresses section
            if (shouldDisplay(bylaw.locationAddresses)) {
                const locationSection = document.createElement('div');
                locationSection.className = 'bylaw-section';
                locationSection.innerHTML = `<h4 class="section-title">Location Addresses</h4>`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'section-content';
                
                // Process locations - they might be separated by ||| or %%% or newlines
                let locations = [];
                if (typeof bylaw.locationAddresses === 'string') {
                    // Split by various separators
                    locations = bylaw.locationAddresses
                        .split(/\|\|\||%%%|\n/)
                        .map(loc => loc.trim())
                        .filter(loc => loc && loc.toLowerCase() !== 'none');
                } else if (Array.isArray(bylaw.locationAddresses)) {
                    locations = bylaw.locationAddresses.filter(loc => loc && loc.toLowerCase() !== 'none');
                }
                
                if (locations.length > 0) {
                    const locationList = document.createElement('ul');
                    locations.forEach(location => {
                        const encodedLocation = encodeURIComponent(location + ', Ontario, Canada');
                        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedLocation}`;
                        
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer">${location}</a>`;
                        locationList.appendChild(listItem);
                    });
                    contentDiv.appendChild(locationList);
                } else {
                    contentDiv.innerHTML = `<p>${formatText(bylaw.locationAddresses)}</p>`;
                }
                
                locationSection.appendChild(contentDiv);
                container.appendChild(locationSection);
            }
            
            // Money and Categories section
            const moneySection = createSection('Money and Categories', bylaw.moneyAndCategories);
            if (moneySection) container.appendChild(moneySection);
            
            // Keywords section
            const keywordsSection = createSection('Keywords', bylaw.keywords);
            if (keywordsSection) container.appendChild(keywordsSection);
            
            // Other Details section
            const otherDetailsSection = createSection('Other Details', bylaw.otherDetails);
            if (otherDetailsSection) container.appendChild(otherDetailsSection);
            
            // News Sources section
            const newsSourcesSection = createSection('News Sources', bylaw.newsSources);
            if (newsSourcesSection) container.appendChild(newsSourcesSection);
            
            // Image Description section
            if (bylaw.hasEmbeddedImages && shouldDisplay(bylaw.imageDesciption)) {
                const imageSection = createSection('Image Description', bylaw.imageDesciption);
                if (imageSection) container.appendChild(imageSection);
            }
            
            // Map Description section
            if (bylaw.hasEmbeddedMaps && shouldDisplay(bylaw.mapDescription)) {
                const mapSection = createSection('Map Description', bylaw.mapDescription);
                if (mapSection) container.appendChild(mapSection);
            }
            
            // URL Original Document section
            if (shouldDisplay(bylaw.urlOriginalDocument)) {
                const urlSection = document.createElement('div');
                urlSection.className = 'bylaw-section';
                
                // Extract the PDF filename from the URL
                let pdfName = "document";
                if (bylaw.urlOriginalDocument && typeof bylaw.urlOriginalDocument === 'string') {
                    const urlParts = bylaw.urlOriginalDocument.split('/');
                    if (urlParts.length > 0) {
                        const lastPart = urlParts[urlParts.length - 1];
                        if (lastPart.includes('?')) {
                            pdfName = lastPart.split('?')[0];
                        } else {
                            pdfName = lastPart;
                        }
                    }
                }
                
                urlSection.innerHTML = `
                    <h4 class="section-title">Original Town Document</h4>
                    <div class="section-content">
                        <p><a href="${bylaw.urlOriginalDocument}" target="_blank" rel="noopener noreferrer">${pdfName}</a></p>
                    </div>
                `;
                container.appendChild(urlSection);
            }
            
            // Table section
            if (shouldDisplay(bylaw.table)) {
                const tableContent = formatTable(bylaw.table);
                const tableSection = createSection('Table Data', tableContent, true, true);
                if (tableSection) container.appendChild(tableSection);
            }
            
            // Full text section
            if (shouldDisplay(bylaw.extractedText)) {
                const textContent = Array.isArray(bylaw.extractedText) 
                    ? bylaw.extractedText.join('\n') 
                    : bylaw.extractedText;
                
                const textSection = document.createElement('div');
                textSection.className = 'bylaw-section full-width';
                textSection.innerHTML = `
                    <h4 class="section-title">Full Text</h4>
                    <div class="section-content">
                        <div class="bylaw-text">${formatText(textContent)}</div>
                    </div>
                `;
                container.appendChild(textSection);
            }
            
            // Add the container to the content area
            contentArea.appendChild(container);
        }

        // Search functionality
        searchInput.addEventListener('input', function() {
            renderBylawList(this.value);
        });

        // Handle file drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Handle dropped files
        dropzone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // Handle file input selection
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });

        // Process the files
        function handleFiles(files) {
            if (files.length === 0) return;
            
            uploadedFiles = [];
            bylawData = [];
            
            // Show loading indicator
            bylawList.innerHTML = '<div class="loading"><div class="spinner"></div><span>Processing files...</span></div>';
            
            // Add file info section
            contentArea.innerHTML = `
                <div class="file-info">
                    <div class="file-text">
                        <span class="file-count">${files.length} file(s) selected</span>
                    </div>
                    <div class="file-action">
                        <button class="btn btn-outline" id="clear-files">Clear All</button>
                    </div>
                </div>
                <div class="no-bylaws">
                    <h2>Select a bylaw from the sidebar to view its details</h2>
                </div>
            `;
            
            // Add event listener to clear button
            document.getElementById('clear-files').addEventListener('click', function() {
                clearFiles();
            });
            
            // Parse each file
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        uploadedFiles.push({
                            name: file.name,
                            data: jsonData
                        });
                        
                        // When all files are processed
                        if (uploadedFiles.length === files.length) {
                            processUploadedFiles();
                        }
                    } catch (error) {
                        console.error('Error parsing JSON file:', error);
                        bylawList.innerHTML = `<div class="no-bylaws">Error parsing JSON: ${error.message}</div>`;
                    }
                };
                
                reader.readAsText(file);
            });
            
            // Hide the dropzone
            dropzone.classList.add('hidden');
        }

        // Process the uploaded JSON files
        function processUploadedFiles() {
            try {
                // Extract bylaw data from the uploaded files
                uploadedFiles.forEach(file => {
                    // Add the file's data to bylawData
                    bylawData.push(file.data);
                });
                
                // Render the bylaw list
                renderBylawList();
            } catch (error) {
                console.error('Error processing files:', error);
                bylawList.innerHTML = `<div class="no-bylaws">Error processing files: ${error.message}</div>`;
            }
        }

        // Clear all files and reset the viewer
        function clearFiles() {
            uploadedFiles = [];
            bylawData = [];
            fileInput.value = ''; // Clear the file input
            
            // Reset the UI
            bylawList.innerHTML = '<div class="no-bylaws">No bylaws loaded</div>';
            contentArea.innerHTML = '<div class="no-bylaws"><h2>Upload JSON files to view bylaws</h2></div>';
            
            // Show the dropzone again
            dropzone.classList.remove('hidden');
        }

        // Initialize the viewer
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup
            dropzone.classList.remove('hidden');
            bylawList.innerHTML = '<div class="no-bylaws">No bylaws loaded</div>';
            contentArea.innerHTML = '<div class="no-bylaws"><h2>Upload JSON files to view bylaws</h2></div>';
        });
    </script>
</body>
</html>
